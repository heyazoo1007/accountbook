<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/event-stream; charset=utf-8"/>
    <title>AccountBook Main Home</title>

    <!--아래 3개의 순서가 중요하다-->
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>

    <style>
        .calendar {
            padding-top: 60px;
            position: relative;
            margin: 0 auto;
        }

        .calendar .days {
            display: flex;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .calendar .day {
            display:flex;
            align-items: center;
            justify-content: center;
            width: calc(100% / 7);
            text-align: left;
            color: #999;
            font-size: 12px;
            text-align: center;
            border-radius:5px
        }

        .calendar .dates {
            display: flex;
            flex-flow: wrap;
            height: 290px;
        }
    </style>

</head>

<body>
<div id="top" class="container text-center">
    <div class="row">
        <div class="col-2"><a href="/index">AccountBook</a></div>
        <div class="col-8">My AccountBook</div>
        <div class="col-2">마이 페이지</div>
    </div>
</div>

<div id="middle" class="container text-center" style="padding-top:50px;">
    <div class="row">
        <div class="col align-self-start">
            <div class="row">
                <div class="col-auto"><button class="btn btn-light nav-btn-prev" onclick="goPrev();"><</button></div>
                <div id="year-month" class="col-auto"></div>
                <div class="col-auto"><button class="btn btn-light nav-btn-next" onclick="goNext();">></button></div>
            </div>
        </div>
            <div class="col align-self-end"><button type="button" class="btn btn-success" id="budgetToastBtn" onclick="getAlarm();">예산 알림 받기</button></div>
    </div>
</div>

<div class="calendar">
    <div class="days">
        <div class="day">MON</div>
        <div class="day">TUE</div>
        <div class="day">WED</div>
        <div class="day">THU</div>
        <div class="day">FRI</div>
        <div class="day">SAT</div>
        <div class="day">SUN</div>
    </div>
    <div class="dates"></div>
</div>

<div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dateModalLabel">오늘의 지출내역(월/일 받아서 입력하기)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="location.href='/expenditure'">+ 지출 입력하기</button>
            </div>
        </div>
    </div>
</div>

<!--예산 알림 토스트-->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="budgetToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">이번 달 예산 알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

</body>
<script>

    var stompClient = null;
    var memberId = window.location.pathname.split('/')[2];
    var currentYear = '';
    var currentMonth = '';
    var currentDate = '';
    $(document).ready(function() {
        // 한국 표준시간 가져오기
        var date = new Date();
        var utc = date.getTime() + (date.getTimezoneOffset() * 60 * 1000);
        var kstGap = 9 * 60 * 60 * 1000;
        var today = new Date(utc + kstGap);
        var thisMonth = new Date(today.getFullYear(), today.getMonth(), today.getDate());

        // 연, 월, 일 가져오기
        currentYear = thisMonth.getFullYear();
        currentMonth = thisMonth.getMonth();
        currentDate = thisMonth.getDate();

        // 페이지 로딩 초기에 달력 가져오기
        renderCalendar(currentYear, currentMonth, currentDate);

        // 웹소켓 연결하기
        connectWebSocket(memberId);
    });

    function renderCalendar(currentYear, currentMonth, currentDate) {
        $('#year-month').text(currentYear + '.' + (currentMonth + 1));

        // 지난달 마지막 날짜, 요일 구하기
        var startDay = new Date(currentYear, currentMonth, 0);
        var prevDate = startDay.getDate();
        var prevDay = startDay.getDay();

        // 이번 달의 마지막 날짜, 요일 구하기
        var endDay = new Date(currentYear, currentMonth + 1, 0);
        var nextDate = endDay.getDate();
        var nextDay = endDay.getDay();

        calendar = document.querySelector('.dates')
        calendar.innerHTML = '';

        for (var i = prevDate - prevDay + 1; i <= prevDate; i++) {
            calendar.innerHTML = calendar.innerHTML + '<div class="day prev disable"></div>'
        }

        for (var i = 1; i <= nextDate; i++) {
            calendar.innerHTML = calendar.innerHTML + '<button type="button" id=' + i + ' class="day current btn-light" data-bs-toggle="modal" data-bs-target="#dateModal" onclick="modal(this.id);">' + i + '</button> ';
        }
    }

    function connectWebSocket(memberId) {
        const socket = new SockJS('http://localhost:8080/ws-stomp');
        stompClient = Stomp.over(socket);
        var accessToken = document.cookie.split('access_token=')[1];
        stompClient.connect({"token" : accessToken},
                             function (frame) {
                                 stompClient.subscribe('/sub/' + memberId, function (response) {

                                 document.querySelector('.toast-body').innerHTML = JSON.parse(response.body).message;
                                 $('.toast').toast('show');
                             });
        });
    }

    function goPrev() {
        currentMonth -= 1
        if (currentMonth == -1) {
            currentYear -= 1;
            currentMonth = 11;
        }
        renderCalendar(currentYear, currentMonth, 1);
    }

    function goNext() {
        currentMonth += 1
        if (currentMonth == 12) {
            currentYear += 1;
            currentMonth = 0;
        }
        renderCalendar(currentYear, currentMonth, 1);
    }


    var paymentsCheck = 0;
    var dateCheck = '';
    function modal(clickedId) {
        // 모달 헤더 가지고 온 뒤 날짜 동적으로 텍스트 변경하기
        var dateModalLabel = document.getElementById('dateModalLabel');
        dateModalLabel.innerHTML = (currentMonth + 1) + '월 ' + clickedId + '일 지출내역';


        // 클릭한 날짜로 요청 메시지 보내기, 응답 받은 걸로 modal-body 변경하기
        var requestDate = currentYear + '-' + (currentMonth + 1) + '-' + clickedId;
        $.ajax({
            url : `/v1/daily-payments/list/` + requestDate,
            type : 'get',
            contentType : 'application/json; charset=utf-8;',
            dataType : 'json',
            success : function(response) {
                var data = response.data;

                modalContent = document.querySelector('.modal-body');
                modalContent.innerHTML = ''; // 모달 바디 초기화
                var content = `<ul> `;
                for(var i = 0; i < data.length; i++) {
                    var paymentId = data[i].dailyPaymentId;
                    var paidAmount = data[i].paidAmount;
                    var payLocation = data[i].payLocation;
                    var methodOfPayment = data[i].methodOfPayment;
                    var categoryId = data[i].categoryId;
                    var categoryName = data[i].categoryName;
                    var memo = data[i].memo
                    content += `<li id="` + paymentId + `">` +
                                 paidAmount +`|`+ payLocation + `|` + methodOfPayment + `|` + categoryName + `|` + memo + '                  ' +
                                 `<button class="btn btn-success btn-payment" id="`+ paymentId + `" onclick="modifyDailyPayments(this.id);">수정</button></li> `;
                }
                modalContent.innerHTML += (content + `</ul>`);
            },
            error : function(request, status, error) {
                alert(JSON.parse(request.responseText).message);
            }
        })
    }

    function modifyDailyPayments(paymentId) {
        location.replace("http://localhost:8080/expenditure/" + paymentId);
    }

    function getAlarm() {
        stompClient.send("/app/v1/budget/alarm/" + memberId, {}, {});
    }
</script>

</html>
